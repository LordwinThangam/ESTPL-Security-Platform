
{% extends "base.html" %}
{% block title %}DNS Security{% endblock %}
{% block content %}
<div class="container-fluid">
    <div class="card">
        <div class="card-header bg-info text-white">
            <h4><i class="fas fa-globe"></i> DNS Security Center</h4>
            <p class="mb-0">DNSSEC Validation • DNS Blocking • Threat Protection</p>
        </div>
        <div class="card-body">
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body text-center">
                            <h5>{{ stats.total_queries }}</h5>
                            <small>Total DNS Queries</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-danger text-white">
                        <div class="card-body text-center">
                            <h5>{{ stats.blocked_queries }}</h5>
                            <small>Blocked Queries</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body text-center">
                            <h5>{{ stats.malicious_domains }}</h5>
                            <small>Malicious Domains</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body text-center">
                            <h5>{{ stats.dnssec_validated }}</h5>
                            <small>DNSSEC Validated</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-shield-alt"></i> DNSSEC Status</h5>
                        </div>
                        <div class="card-body">
                            <p><strong>Status:</strong> <span class="badge badge-success">{{ stats.dnssec_status }}</span></p>
                            <p><strong>DNS Filtering:</strong> <span class="badge badge-success">{{ stats.dns_filtering }}</span></p>
                            <h6>Security Features:</h6>
                            <ul>
                                {% for feature in stats.security_features %}
                                <li>{{ feature }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-chart-pie"></i> Threat Categories</h5>
                        </div>
                        <div class="card-body">
                            {% for category, count in stats.threat_categories.items() %}
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-capitalize">{{ category }}</span>
                                <span class="badge badge-danger">{{ count }}</span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- DNS & IP Blocking Section -->
            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="card border-danger">
                        <div class="card-header bg-danger text-white">
                            <h5><i class="fas fa-ban"></i> DNS Domain Blocking</h5>
                        </div>
                        <div class="card-body">
                            <form method="POST" action="/api/dns-block-domain">
                                <div class="form-group mb-3">
                                    <label><strong>Block Domain:</strong></label>
                                    <input type="text" name="domain" class="form-control" placeholder="example.com" required>
                                    <small class="text-muted">Enter domain without http:// or https://</small>
                                </div>
                                <div class="form-group mb-3">
                                    <label><strong>Block Reason:</strong></label>
                                    <select name="reason" class="form-control" required>
                                        <option value="malware">Malware Distribution</option>
                                        <option value="phishing">Phishing Site</option>
                                        <option value="spam">Spam/Advertising</option>
                                        <option value="malicious">Malicious Activity</option>
                                        <option value="policy">Policy Violation</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                                <div class="form-group mb-3">
                                    <label><strong>Block Duration:</strong></label>
                                    <select name="duration" class="form-control">
                                        <option value="1h">1 Hour</option>
                                        <option value="24h">24 Hours</option>
                                        <option value="7d">7 Days</option>
                                        <option value="30d" selected>30 Days</option>
                                        <option value="permanent">Permanent</option>
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-danger btn-block">
                                    <i class="fas fa-shield-alt"></i> Block Domain
                                </button>
                            </form>
                            
                            <hr class="my-4">
                            
                            <h6 class="mb-3"><i class="fas fa-list-ul"></i> Currently Blocked Domains</h6>
                            <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                                <table class="table table-sm table-hover">
                                    <thead class="thead-light">
                                        <tr>
                                            <th>Domain</th>
                                            <th>Reason</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% if blocked_domains %}
                                            {% for domain in blocked_domains %}
                                            <tr>
                                                <td><small><code>{{ domain.domain }}</code></small></td>
                                                <td><small><span class="badge badge-danger">{{ domain.reason }}</span></small></td>
                                                <td>
                                                    <button class="btn btn-sm btn-outline-success" onclick="unblockDomain('{{ domain.domain }}')">
                                                        <i class="fas fa-unlock"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        {% else %}
                                            <tr>
                                                <td colspan="3" class="text-center text-muted">
                                                    <small>No blocked domains</small>
                                                </td>
                                            </tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card border-warning">
                        <div class="card-header bg-warning text-dark">
                            <h5><i class="fas fa-network-wired"></i> IP Address Blocking</h5>
                        </div>
                        <div class="card-body">
                            <form method="POST" action="/api/dns-block-ip">
                                <div class="form-group mb-3">
                                    <label><strong>Block IP Address:</strong></label>
                                    <input type="text" name="ip_address" class="form-control" placeholder="192.168.1.100" required pattern="^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$">
                                    <small class="text-muted">Enter IPv4 address (e.g., 192.168.1.100)</small>
                                </div>
                                <div class="form-group mb-3">
                                    <label><strong>Block Reason:</strong></label>
                                    <select name="reason" class="form-control" required>
                                        <option value="brute_force">Brute Force Attack</option>
                                        <option value="ddos">DDoS Attack</option>
                                        <option value="scanning">Port Scanning</option>
                                        <option value="malicious">Malicious Activity</option>
                                        <option value="suspicious">Suspicious Behavior</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                                <div class="form-group mb-3">
                                    <label><strong>Block Duration:</strong></label>
                                    <select name="duration" class="form-control">
                                        <option value="1h">1 Hour</option>
                                        <option value="24h" selected>24 Hours</option>
                                        <option value="7d">7 Days</option>
                                        <option value="30d">30 Days</option>
                                        <option value="permanent">Permanent</option>
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-warning btn-block">
                                    <i class="fas fa-ban"></i> Block IP Address
                                </button>
                            </form>
                            
                            <hr class="my-4">
                            
                            <h6 class="mb-3"><i class="fas fa-list-ul"></i> Currently Blocked IPs</h6>
                            <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                                <table class="table table-sm table-hover">
                                    <thead class="thead-light">
                                        <tr>
                                            <th>IP Address</th>
                                            <th>Reason</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% if blocked_ips %}
                                            {% for ip in blocked_ips %}
                                            <tr>
                                                <td><small><code>{{ ip.ip_address }}</code></small></td>
                                                <td><small><span class="badge badge-warning">{{ ip.reason }}</span></small></td>
                                                <td>
                                                    <button class="btn btn-sm btn-outline-success" onclick="unblockIP('{{ ip.ip_address }}')">
                                                        <i class="fas fa-unlock"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        {% else %}
                                            <tr>
                                                <td colspan="3" class="text-center text-muted">
                                                    <small>No blocked IPs</small>
                                                </td>
                                            </tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-list"></i> Top Blocked Domains</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Domain</th>
                                            <th>Category</th>
                                            <th>Block Count</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for domain in stats.top_blocked_domains %}
                                        <tr>
                                            <td><code>{{ domain.domain }}</code></td>
                                            <td><span class="badge badge-secondary">{{ domain.category }}</span></td>
                                            <td><span class="badge badge-warning">{{ domain.count }}</span></td>
                                            <td><span class="badge badge-success">Blocked</span></td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function unblockDomain(domain) {
    if (!confirm('Unblock domain: ' + domain + '?')) return;
    
    fetch('/api/dns-unblock-domain', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({domain: domain})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Domain unblocked successfully!');
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    });
}

function unblockIP(ip) {
    if (!confirm('Unblock IP address: ' + ip + '?')) return;
    
    fetch('/api/dns-unblock-ip', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ip_address: ip})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('IP address unblocked successfully!');
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    });
}
</script>

{% endblock %}
