{% extends "base.html" %}
{% block title %}SIEM - Log Collection{% endblock %}
{% block content %}

<div class="container-fluid">
    <div class="card">
        <div class="card-header bg-warning text-dark">
            <h4><i class="fas fa-database"></i> Stage â‘  Log Collection</h4>
            <p class="mb-0">Gather data from servers, firewalls, apps & endpoints</p>
        </div>
        <div class="card-body">
            <!-- Statistics -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body text-center">
                            <h3>{{ stats.total_logs_collected }}</h3>
                            <small>Total Logs Collected</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-dark">
                        <div class="card-body text-center">
                            <h3>{{ stats.pending_processing }}</h3>
                            <small>Pending Processing</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h6>By Source Type:</h6>
                            {% for source, count in stats.by_source_type.items() %}
                            <div class="d-flex justify-content-between">
                                <span>{{ source.title() }}:</span>
                                <strong>{{ count }}</strong>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Log Collection Form -->
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5><i class="fas fa-plus"></i> Collect New Log</h5>
                </div>
                <div class="card-body">
                    <form id="collectLogForm">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <div class="row">
                            <div class="col-md-3">
                                <label>Source Type:</label>
                                <select name="source_type" class="form-control" required>
                                    <option value="syslog">Syslog</option>
                                    <option value="firewall">Firewall</option>
                                    <option value="application">Application</option>
                                    <option value="endpoint">Endpoint</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label>Source IP:</label>
                                <input type="text" name="source_ip" class="form-control" placeholder="192.168.1.1" required>
                            </div>
                            <div class="col-md-6">
                                <label>Additional Info:</label>
                                <input type="text" name="app_name" id="app_name" class="form-control" placeholder="App Name / Endpoint ID">
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <label>Log Content:</label>
                                <textarea name="log_content" class="form-control" rows="4" required placeholder="Enter log content here..."></textarea>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary mt-3">
                            <i class="fas fa-upload"></i> Collect Log
                        </button>
                    </form>
                </div>
            </div>

            <!-- Example Logs -->
            <div class="card mt-4">
                <div class="card-header">
                    <h6><i class="fas fa-info-circle"></i> Example Log Formats</h6>
                </div>
                <div class="card-body">
                    <strong>Syslog:</strong>
                    <code>&lt;134&gt;Oct 17 12:00:00 server1 sshd: Failed password for admin from 192.168.1.100</code>
                    <br><br>
                    <strong>Firewall:</strong>
                    <code>DENY TCP 192.168.1.100:45123 -> 10.0.0.5:22 FLAGS:SYN</code>
                    <br><br>
                    <strong>Application:</strong>
                    <code>{"user": "admin", "action": "login_failed", "ip": "192.168.1.100"}</code>
                </div>
            </div>

            <div class="mt-3">
                <a href="/siem-dashboard" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back to SIEM Dashboard
                </a>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('collectLogForm').onsubmit = function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    
    fetch('/siem-collect-log', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Log collected successfully! ID: ' + data.log_id);
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    });
};
</script>

{% endblock %}