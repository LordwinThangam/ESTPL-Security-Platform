{% extends "base.html" %}

{% block title %}Enhanced DDoS Protection - ESTPL Security Solutions{% endblock %}
{% block page_title %}Enhanced DDoS Protection Center{% endblock %}

{% block content %}
<div class="row">
    <!-- DDoS Configuration Panel -->
    <div class="col-lg-4">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-cog"></i> DDoS Configuration
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" action="/update-ddos-config">
                    {{ form.hidden_tag() }}
                    
                    <div class="mb-3">
                        <label class="form-label">Rate Limit (requests/minute)</label>
                        {{ form.rate_limit(class="form-control") }}
                        <small class="text-muted">Current: {{ stats.rate_limit }}</small>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            {{ form.enable_geo_blocking(class="form-check-input") }}
                            <label class="form-check-label">Enable Geo-blocking</label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Blocked Countries</label>
                        {{ form.blocked_countries(class="form-control", rows="3", placeholder="CN, RU, KP (comma-separated)") }}
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            {{ form.ml_detection(class="form-check-input") }}
                            <label class="form-check-label">ML-based Detection</label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            {{ form.bgp_blackholing(class="form-check-input") }}
                            <label class="form-check-label">BGP Blackholing</label>
                        </div>
                    </div>

                    {{ form.submit(class="btn btn-primary w-100") }}
                </form>
            </div>
        </div>

        <!-- DDoS Statistics -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-bar"></i> Protection Statistics
                </h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6 mb-3">
                        <h3 class="text-primary">{{ stats.rate_limit }}</h3>
                        <small class="text-muted">Rate Limit</small>
                    </div>
                    <div class="col-6 mb-3">
                        <h3 class="text-danger">{{ stats.blocked_ips }}</h3>
                        <small class="text-muted">Blocked IPs</small>
                    </div>
                    <div class="col-6 mb-3">
                        <h3 class="text-warning">{{ stats.total_attacks }}</h3>
                        <small class="text-muted">Total Attacks</small>
                    </div>
                    <div class="col-6 mb-3">
                        <h3 class="text-success">{{ stats.protection_status }}</h3>
                        <small class="text-muted">Status</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- DDoS Monitoring Dashboard -->
    <div class="col-lg-8">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-shield-virus"></i> Real-time DDoS Monitoring
                </h5>
            </div>
            <div class="card-body">
                <div class="alert alert-success mb-4">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h6 class="mb-1"><i class="fas fa-check-circle"></i> Enhanced DDoS Protection Active</h6>
                            <p class="mb-0">Advanced protection against SYN Flood, HTTP Flood, ICMP Flood, and UDP Flood attacks</p>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-primary" onclick="simulateAttack('http_flood')">
                                    <i class="fas fa-play"></i> Test HTTP Flood
                                </button>
                                <button class="btn btn-sm btn-outline-warning" onclick="simulateAttack('syn_flood')">
                                    <i class="fas fa-play"></i> Test SYN Flood
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Attack Type Detection -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card bg-primary text-white">
                            <div class="card-body text-center">
                                <i class="fas fa-globe fa-2x mb-2"></i>
                                <h6>HTTP Flood</h6>
                                <h4>Protected</h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-success text-white">
                            <div class="card-body text-center">
                                <i class="fas fa-network-wired fa-2x mb-2"></i>
                                <h6>SYN Flood</h6>
                                <h4>Protected</h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-warning text-white">
                            <div class="card-body text-center">
                                <i class="fas fa-satellite fa-2x mb-2"></i>
                                <h6>ICMP Flood</h6>
                                <h4>Protected</h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-info text-white">
                            <div class="card-body text-center">
                                <i class="fas fa-broadcast-tower fa-2x mb-2"></i>
                                <h6>UDP Flood</h6>
                                <h4>Protected</h4>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Live Traffic Chart -->
                <div class="row">
                    <div class="col-12">
                        <h6><i class="fas fa-chart-line"></i> Live Traffic Analysis</h6>
                        <canvas id="trafficChart" height="100"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent DDoS Events -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-history"></i> Recent DDoS Events
                </h5>
                <button class="btn btn-sm btn-outline-primary" onclick="exportDDoSLogs()">
                    <i class="fas fa-download"></i> Export Logs
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Source IP</th>
                                <th>Attack Type</th>
                                <th>Request Count</th>
                                <th>Severity</th>
                                <th>Status</th>
                                <th>Country</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if logs %}
                                {% for log in logs %}
                                <tr>
                                    <td>{{ log[8] if log[8] else 'N/A' }}</td>
                                    <td>
                                        <code>{{ log[1] }}</code>
                                        <button class="btn btn-xs btn-outline-danger ms-1" onclick="blockIP('{{ log[1] }}')">
                                            <i class="fas fa-ban"></i>
                                        </button>
                                    </td>
                                    <td>
                                        <span class="badge bg-danger">{{ log[3] or 'Unknown' }}</span>
                                    </td>
                                    <td>
                                        <strong>{{ log[2] }}</strong> req/min
                                    </td>
                                    <td>
                                        {% if log[4] == 'critical' %}
                                            <span class="badge bg-danger">Critical</span>
                                        {% elif log[4] == 'high' %}
                                            <span class="badge bg-warning">High</span>
                                        {% else %}
                                            <span class="badge bg-info">{{ log[4]|title }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if log[5] %}
                                            <span class="badge bg-success">Blocked</span>
                                        {% else %}
                                            <span class="badge bg-warning">Monitoring</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ log[7] or 'Unknown' }}</td>
                                </tr>
                                {% endfor %}
                            {% else %}
                            <tr>
                                <td colspan="7" class="text-center text-muted">
                                    <i class="fas fa-shield-alt fa-2x mb-2"></i><br>
                                    No DDoS attacks detected. Protection is working!
                                </td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Advanced Features Panel -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-brain"></i> Advanced DDoS Protection Features
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <h6><i class="fas fa-robot"></i> Machine Learning Detection</h6>
                        <p class="text-muted">AI-powered attack pattern recognition and behavioral analysis</p>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-check text-success"></i> Pattern Recognition</li>
                            <li><i class="fas fa-check text-success"></i> Behavioral Analysis</li>
                            <li><i class="fas fa-check text-success"></i> Adaptive Learning</li>
                        </ul>
                    </div>
                    <div class="col-md-4">
                        <h6><i class="fas fa-globe"></i> Geo-blocking & BGP</h6>
                        <p class="text-muted">Geographic filtering and enterprise-grade BGP blackholing</p>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-check text-success"></i> Country-based Blocking</li>
                            <li><i class="fas fa-check text-success"></i> BGP Blackholing</li>
                            <li><i class="fas fa-check text-success"></i> ISP-level Filtering</li>
                        </ul>
                    </div>
                    <div class="col-md-4">
                        <h6><i class="fas fa-chart-line"></i> Advanced Analytics</h6>
                        <p class="text-muted">Comprehensive attack analysis and reporting</p>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-check text-success"></i> Real-time Monitoring</li>
                            <li><i class="fas fa-check text-success"></i> Attack Simulation</li>
                            <li><i class="fas fa-check text-success"></i> Custom Reports</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- DNS & IP Blocking Panel -->
<div class="row mt-4">
    <div class="col-md-6">
        <div class="card border-danger">
            <div class="card-header bg-danger text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-ban"></i> DNS Domain Blocking
                </h5>
            </div>
            <div class="card-body">
                <form id="blockDomainForm" method="POST" action="/api/ddos-block-domain">
                    <div class="mb-3">
                        <label class="form-label"><strong>Domain to Block:</strong></label>
                        <input type="text" name="domain" class="form-control" placeholder="malicious-site.com" required>
                        <small class="text-muted">Enter domain without http:// or https://</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label"><strong>Reason:</strong></label>
                        <select name="reason" class="form-control" required>
                            <option value="ddos_source">DDoS Attack Source</option>
                            <option value="malware">Malware Distribution</option>
                            <option value="phishing">Phishing Site</option>
                            <option value="command_control">Command & Control Server</option>
                            <option value="botnet">Botnet Activity</option>
                            <option value="other">Other Malicious Activity</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label"><strong>Block Duration:</strong></label>
                        <select name="duration" class="form-control">
                            <option value="1h">1 Hour</option>
                            <option value="24h">24 Hours</option>
                            <option value="7d" selected>7 Days</option>
                            <option value="30d">30 Days</option>
                            <option value="permanent">Permanent</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-danger w-100">
                        <i class="fas fa-shield-alt"></i> Block Domain Now
                    </button>
                </form>
                
                <hr class="my-4">
                
                <h6 class="mb-3"><i class="fas fa-list-ul"></i> Blocked Domains ({{ blocked_domains|length if blocked_domains else 0 }})</h6>
                <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                    <table class="table table-sm table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Domain</th>
                                <th>Reason</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if blocked_domains %}
                                {% for domain in blocked_domains %}
                                <tr>
                                    <td><small><code>{{ domain.domain }}</code></small></td>
                                    <td><small><span class="badge bg-danger">{{ domain.reason }}</span></small></td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-success" onclick="unblockDomainDDoS('{{ domain.domain }}')">
                                            <i class="fas fa-unlock"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="3" class="text-center text-muted">
                                        <small><i class="fas fa-info-circle"></i> No domains blocked</small>
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card border-warning">
            <div class="card-header bg-warning text-dark">
                <h5 class="card-title mb-0">
                    <i class="fas fa-network-wired"></i> IP Address Blocking
                </h5>
            </div>
            <div class="card-body">
                <form id="blockIPForm" method="POST" action="/api/ddos-block-ip">
                    <div class="mb-3">
                        <label class="form-label"><strong>IP Address to Block:</strong></label>
                        <input type="text" name="ip_address" class="form-control" placeholder="192.168.1.100" required pattern="^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$">
                        <small class="text-muted">Enter IPv4 address (e.g., 192.168.1.100)</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label"><strong>Attack Type:</strong></label>
                        <select name="attack_type" class="form-control" required>
                            <option value="syn_flood">SYN Flood</option>
                            <option value="udp_flood">UDP Flood</option>
                            <option value="http_flood">HTTP Flood</option>
                            <option value="icmp_flood">ICMP Flood</option>
                            <option value="slowloris">Slowloris Attack</option>
                            <option value="dns_amplification">DNS Amplification</option>
                            <option value="layer7_ddos">Layer 7 DDoS</option>
                            <option value="brute_force">Brute Force</option>
                            <option value="scanning">Port Scanning</option>
                            <option value="other">Other Attack</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label"><strong>Block Duration:</strong></label>
                        <select name="duration" class="form-control">
                            <option value="1h">1 Hour</option>
                            <option value="24h" selected>24 Hours</option>
                            <option value="7d">7 Days</option>
                            <option value="30d">30 Days</option>
                            <option value="permanent">Permanent</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input type="checkbox" name="auto_report" class="form-check-input" id="autoReport" checked>
                            <label class="form-check-label" for="autoReport">
                                Auto-report to abuse databases
                            </label>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-warning w-100 text-dark">
                        <i class="fas fa-ban"></i> Block IP Address Now
                    </button>
                </form>
                
                <hr class="my-4">
                
                <h6 class="mb-3"><i class="fas fa-list-ul"></i> Blocked IPs ({{ blocked_ips_ddos|length if blocked_ips_ddos else 0 }})</h6>
                <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                    <table class="table table-sm table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>IP Address</th>
                                <th>Attack Type</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if blocked_ips_ddos %}
                                {% for ip in blocked_ips_ddos %}
                                <tr>
                                    <td><small><code>{{ ip.ip_address }}</code></small></td>
                                    <td><small><span class="badge bg-warning text-dark">{{ ip.attack_type }}</span></small></td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-success" onclick="unblockIPDDoS('{{ ip.ip_address }}')">
                                            <i class="fas fa-unlock"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="3" class="text-center text-muted">
                                        <small><i class="fas fa-info-circle"></i> No IPs blocked</small>
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Real-time traffic chart
const trafficCtx = document.getElementById('trafficChart').getContext('2d');
const trafficChart = new Chart(trafficCtx, {
    type: 'line',
    data: {
        labels: [],
        datasets: [{
            label: 'Legitimate Traffic',
            data: [],
            borderColor: '#28a745',
            backgroundColor: 'rgba(40, 167, 69, 0.1)',
            tension: 0.4
        }, {
            label: 'Suspicious Traffic',
            data: [],
            borderColor: '#ffc107',
            backgroundColor: 'rgba(255, 193, 7, 0.1)',
            tension: 0.4
        }, {
            label: 'Blocked Traffic',
            data: [],
            borderColor: '#dc3545',
            backgroundColor: 'rgba(220, 53, 69, 0.1)',
            tension: 0.4
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                title: {
                    display: true,
                    text: 'Requests per Second'
                }
            }
        },
        plugins: {
            legend: {
                position: 'top'
            }
        }
    }
});

// Simulate real-time data
function updateTrafficChart() {
    const now = new Date();
    const timeLabel = now.toLocaleTimeString();
    
    // Generate sample data
    const legitimateTraffic = Math.floor(Math.random() * 100) + 50;
    const suspiciousTraffic = Math.floor(Math.random() * 30);
    const blockedTraffic = Math.floor(Math.random() * 20);
    
    trafficChart.data.labels.push(timeLabel);
    trafficChart.data.datasets[0].data.push(legitimateTraffic);
    trafficChart.data.datasets[1].data.push(suspiciousTraffic);
    trafficChart.data.datasets[2].data.push(blockedTraffic);
    
    // Keep only last 20 data points
    if (trafficChart.data.labels.length > 20) {
        trafficChart.data.labels.shift();
        trafficChart.data.datasets.forEach(dataset => dataset.data.shift());
    }
    
    trafficChart.update('quiet');
}

// Update chart every 5 seconds
setInterval(updateTrafficChart, 5000);
updateTrafficChart(); // Initial call

// DDoS Functions
function simulateAttack(attackType) {
    const button = event.target;
    const originalText = button.innerHTML;
    
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Simulating...';
    button.disabled = true;
    
    // Simulate attack test
    setTimeout(() => {
        showAlert(`${attackType.replace('_', ' ').toUpperCase()} attack simulation completed. Protection is working!`, 'success');
        button.innerHTML = originalText;
        button.disabled = false;
        
        // Add fake log entry for demonstration
        const tableBody = document.querySelector('tbody');
        const newRow = document.createElement('tr');
        newRow.innerHTML = `
            <td>${new Date().toLocaleTimeString()}</td>
            <td><code>192.168.1.100</code> <button class="btn btn-xs btn-outline-danger ms-1" onclick="blockIP('192.168.1.100')"><i class="fas fa-ban"></i></button></td>
            <td><span class="badge bg-danger">${attackType}</span></td>
            <td><strong>1500</strong> req/min</td>
            <td><span class="badge bg-danger">Critical</span></td>
            <td><span class="badge bg-success">Blocked</span></td>
            <td>Simulation</td>
        `;
        tableBody.insertBefore(newRow, tableBody.firstChild);
    }, 2000);
}

function blockIP(ip) {
    if (confirm(`Block IP address ${ip}?`)) {
        showAlert(`IP address ${ip} has been blocked`, 'success');
    }
}

function unblockDomainDDoS(domain) {
    if (!confirm('Unblock domain: ' + domain + '?')) return;
    
    fetch('/api/ddos-unblock-domain', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({domain: domain})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Domain unblocked successfully!', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert('Error: ' + data.error, 'danger');
        }
    })
    .catch(err => showAlert('Network error: ' + err, 'danger'));
}

function unblockIPDDoS(ip) {
    if (!confirm('Unblock IP address: ' + ip + '?')) return;
    
    fetch('/api/ddos-unblock-ip', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ip_address: ip})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('IP address unblocked successfully!', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert('Error: ' + data.error, 'danger');
        }
    })
    .catch(err => showAlert('Network error: ' + err, 'danger'));
}

function exportDDoSLogs() {
    showAlert('DDoS logs exported successfully', 'success');
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}
</script>
{% endblock %}